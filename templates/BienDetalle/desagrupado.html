{% extends 'base/base.html' %}
{% block contenido %}
<div class="card shadow">
    <h5 class="card-header text-center" style="background-color: #0b3873; color: white;">
        BIENES - {{ nombre_bien }}
    </h5>
    <div class="card-body" style="position: relative;z-index: 0;background: rgba(220, 218, 218, 0.5);border-radius: 10px;backdrop-filter: blur(10px);box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
        <a href="{% url 'inventario:home_bienesnacionales' %}" class="btn btn-secondary mb-3">
            <i class="bi bi-arrow-left"></i> Volver a inventario agrupado
        </a>
        <div class="dropdown mb-3 text-right">
            <button 
                class="btn btn-secondary dropdown-toggle" 
                type="button" 
                id="columnDropdown" 
                data-bs-toggle="dropdown" 
                aria-expanded="false">
                Columnas
            </button>
            <ul class="dropdown-menu" aria-labelledby="columnDropdown">
                <li style="display: none;">
        <div class="form-check dropdown-item">
            <input class="form-check-input" type="checkbox" data-col="0" id="col-0" checked>
            <label class="form-check-label" for="col-0">checkbox</label>
        </div>
    </li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="1" id="col-1" checked><label class="form-check-label" for="col-1">ID</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="2" id="col-2" checked><label class="form-check-label" for="col-2">Número de Inventario</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="3" id="col-3" checked><label class="form-check-label" for="col-3">Imagen</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="4" id="col-4" checked><label class="form-check-label" for="col-4">Nombre</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="5" id="col-5" checked><label class="form-check-label" for="col-5">Categoría</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="6" id="col-6" checked><label class="form-check-label" for="col-6">Subcategoría</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="7" id="col-7" checked><label class="form-check-label" for="col-7">Compañía</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="8" id="col-8" checked><label class="form-check-label" for="col-8">Manufacturera</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="9" id="col-9" checked><label class="form-check-label" for="col-9">Fabricante</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="10" id="col-10" checked><label class="form-check-label" for="col-10">Proveedor</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="11" id="col-11" checked><label class="form-check-label" for="col-11">Serial</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="12" id="col-12" checked><label class="form-check-label" for="col-12">Modelo</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="13" id="col-13" checked><label class="form-check-label" for="col-13">Unidad de Medida</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="14" id="col-14" checked><label class="form-check-label" for="col-14">Ubicación</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="15" id="col-15" checked><label class="form-check-label" for="col-15">Número de Orden</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="16" id="col-16" checked><label class="form-check-label" for="col-16">Número de Factura</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="17" id="col-17" checked><label class="form-check-label" for="col-17">Costo de Compra</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="18" id="col-18" checked><label class="form-check-label" for="col-18">Fecha de Compra</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="19" id="col-19" checked><label class="form-check-label" for="col-19">Estado(s)</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="20" id="col-20" checked><label class="form-check-label" for="col-20">Responsable</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="21" id="col-21" checked><label class="form-check-label" for="col-21">Notas</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="22" id="col-22" checked><label class="form-check-label" for="col-22">Creado</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="23" id="col-23" checked><label class="form-check-label" for="col-23">Modificado</label></div></li>
    <li><div class="form-check dropdown-item"><input class="form-check-input toggle-col" type="checkbox" data-col="24" id="col-24" checked><label class="form-check-label" for="col-24">Acciones</label></div></li>
</ul>
            <button id="export-pdf" class="btn btn-danger ms-3">
                <i class="bi bi-file-earmark-pdf"></i>
                PDF
            </button>
        </div>
        <!-- Dropdown para columnas y PDF -->
        
        

        <div style="overflow-x:auto; width:100%;">
            <table id="tablaBienes" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>ID</th>
                        <th>Número de Inventario</th>
                        <th>Imagen</th>
                        <th>Nombre</th>
                        <th>Categoría</th>
                        <th>Subcategoría</th>
                        <th>Compañía</th>
                        <th>Manufacturera</th>
                        <th>Fabricante</th>
                        <th>Proveedor</th>
                        <th>Serial</th>
                        <th>Modelo</th>
                        <th>Unidad de Medida</th>
                        <th>Ubicación</th>
                        <th>Número de Orden</th>
                        <th>Número de Factura</th>
                        <th>Costo de Compra</th>
                        <th>Fecha de Compra</th>
                        <th>Estado(s)</th>
                        <th>Responsable</th>
                        <th>Notas</th>
                        <th>Creado</th>
                        <th>Modificado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bien in bienes %}
                    <tr data-id="{{ bien.id }}" id="bien-{{ bien.id }}">
                        <td><input type="checkbox" class="row-select"></td>
                        <td>{{ bien.id }}</td>
                        <td>{{ bien.numero_inventario }}</td>
                        <td>
                            {% if bien.imagen_mostrar %}
                                <img src="{{ bien.imagen_mostrar }}" alt="Imagen" style="max-width: 70px; max-height: 70px;">
                            {% else %}
                                <span class="text-muted">Sin imagen</span>
                            {% endif %}
                        </td>
                        <td>{{ bien.nombre_bien }}</td>
                        <td>{{ bien.categoria }}</td>
                        <td>{{ bien.subcategoria }}</td>
                        <td>{{ bien.compania }}</td>
                        <td>{{ bien.manufacturera }}</td>
                        <td>{{ bien.fabricante }}</td>
                        <td>{{ bien.proveedor }}</td>
                        <td>{{ bien.serial }}</td>
                        <td>{{ bien.numero_modelo }}</td>
                        <td>{{ bien.unidad_medida }}</td>
                        <td>{{ bien.ubicacion }}</td>
                        <td>{{ bien.numero_orden }}</td>
                        <td>{{ bien.numero_factura }}</td>
                        <td>
                            {% if bien.costo_compra %}
                                L. {{ bien.costo_compra|floatformat:2 }}
                            {% else %}
                                <span class="text-muted">No especificado</span>
                            {% endif %}
                        </td>
                        <td>{{ bien.fecha_compra|date:"d/m/Y" }}</td>
                        <td>
                            {% for estado in bien.estado_fisico.all %}
                                <span class="badge" style="background-color: {{ estado.color_hex|default:'#adb5bd' }}; color: white;">{{ estado }}</span>
                            {% empty %}
                                <span class="text-muted">Sin estado</span>
                            {% endfor %}
                        </td>
                        <td>
                            {% if bien.responsable %}
                                {{ bien.responsable }}
                            {% else %}
                                <span class="text-muted">No asignado</span>
                            {% endif %}
                        </td>
                        <td>{{ bien.notas }}</td>
                        <td>{{ bien.creado|date:"d/m/Y H:i:s" }}</td>
                        <td>{{ bien.modificado|date:"d/m/Y H:i:s" }}</td>
                        <td>
                            <a href="{% url 'bien_detalle:editar' bien.id %}" class="btn btn-info btn-sm mb-3">
                                <i class="bi bi-pencil-square"></i> Ver Detalles
                            </a>
                            <a href="{% url 'asignaciones:asignar' bien.id %}" class="btn btn-info btn-sm mb-3">
                                <i class="bi bi-pencil-square"></i> Asignar Bien
                            </a>
                            <a href="{% url 'bien_detalle:eliminar' bien.id %}" class="btn btn-danger btn-sm">
                                <i class="bi bi-trash"></i> Eliminar
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="25" class="text-center">No hay bienes para este criterio.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL PARA EXPORTAR PDF -->
        <div class="modal fade" id="pdfExportModal" tabindex="1" aria-labelledby="pdfExportModalLabel" aria-hidden="true" style="z-index: 2000;">
  <div class="modal-dialog modal-dialog-centered modal-lg" style="z-index: 1999;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pdfExportModalLabel">Exportar PDF</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-center">
        <p>¿En qué formato deseas exportar el PDF?</p>
        <button type="button" class="btn btn-outline-primary me-2" id="pdf-vertical">Carta (Vertical)</button>
        <button type="button" class="btn btn-outline-secondary" id="pdf-horizontal">Horizontal (Apaisado)</button>
        <div id="pdf-export-error" style="display:none; color: red; font-weight: bold; margin-top: 10px;"></div>
      </div>
    </div>
  </div>
</div>
        <!-- FIN MODAL -->

{% load static %}
<script src="{% static '/base/vendor/jquery/jquery.js' %}"></script>
<script>
$(document).ready(function() {
    var table = $('#tablaBienes').DataTable({
        language: {
            decimal:        "",
            emptyTable:     "No hay datos disponibles",
            info:           "Mostrando _START_ a _END_ de _TOTAL_ registros",
            infoEmpty:      "Mostrando 0 a 0 de 0 registros",
            infoFiltered:   "(filtrado de _MAX_ registros totales)",
            lengthMenu:     "Mostrar _MENU_ registros",
            loadingRecords: "Cargando...",
            processing:     "Procesando...",
            search:         "Buscar:",
            zeroRecords:    "No se encontraron registros",
            paginate: {
                first:    "Primero",
                last:     "Último",
                next:     "Siguiente",
                previous: "Anterior"
            },
            aria: {
                sortAscending:  ": activar orden ascendente",
                sortDescending: ": activar orden descendente"
            },
            buttons: {
                colvis: "Columnas"
            }
        },
        columnDefs: [
            { orderable: false, searchable: false, targets: 0 },
            // Actualiza los índices de columnas a ocultar por defecto si quieres
        ]
    });

    // Inicializa checkboxes según visibilidad
    $('.toggle-col').each(function(){
        var idx = $(this).data('col');
        $(this).prop('checked', table.column(idx).visible());
    });
    $('.toggle-col').on('change', function(){
        table.column($(this).data('col')).visible(this.checked);
    });

    $('#select-all').on('change', function(){
        $('.row-select').prop('checked', this.checked);
    });

    $(function(){
    let hash = window.location.hash;
    if (hash && $(hash).length) {
        let $bien = $(hash);
        $bien.addClass('table-success'); // Cambia la clase si quieres otro color
        // Scroll para que se vea bien en la pantalla
        $('html, body').animate({ scrollTop: $bien.offset().top - 120 }, 500);

        // Si quieres que el highlight se quite después de unos segundos:
        setTimeout(function() {
            $bien.removeClass('table-success');
        }, 4000);
    }
});

    // PDF Export
    $('#export-pdf').on('click', function(e){
        e.preventDefault();
        var cols = [];
        $('.toggle-col').each(function(){
            var idx = $(this).data('col');
            if ($(this).prop('checked')) {
                cols.push(idx);
            }
        });

        window.selectedPdfCols = cols;
        window.selectedPdfIds = [];
        table.rows({ search: 'applied' }).every(function(){
            var $row = $(this.node());
            if ($row.find('.row-select').prop('checked')) {
                window.selectedPdfIds.push($row.data('id'));
            }
        });
        if (!window.selectedPdfIds.length) {
            table.rows({ search: 'applied' }).every(function(){
                window.selectedPdfIds.push($(this.node()).data('id'));
            });
        }
        var modal = new bootstrap.Modal(document.getElementById('pdfExportModal'));
        modal.show();

        $('#pdf-vertical').off('click').on('click', function(){
            if (cols.length > 7) {
                $('#pdf-export-error')
                    .text('Solo puedes exportar un máximo de 7 columnas al PDF. Reduce la selección.')
                    .show();
                setTimeout(function() { $('#pdf-export-error').fadeOut(); }, 4000);
                return;
            }
            $('#pdf-export-error').hide();
            exportarPDFvertical();
        });
        $('#pdf-horizontal').off('click').on('click', function(){
            if (cols.length > 11) {
                $('#pdf-export-error')
                    .text('Solo puedes exportar un máximo de 11 columnas al PDF. Reduce la selección.')
                    .show();
                setTimeout(function() { $('#pdf-export-error').fadeOut(); }, 4000);
                return;
            }
            $('#pdf-export-error').hide();
            exportarPDFhorizontal();
        });

        function exportarPDFvertical() {
            var params = [];
            if (window.selectedPdfCols.length)
                params.push('cols=' + window.selectedPdfCols.join(','));
            if (window.selectedPdfIds.length)
                params.push('ids=' + window.selectedPdfIds.join(','));
            var url = "{% url 'bien_detalle:inventario_pdfv' nombre_bien categoria_id subcategoria_id %}";
            if (params.length) {
                url += '?' + params.join('&');
            }
            var modal = bootstrap.Modal.getInstance(document.getElementById('pdfExportModal'));
            modal.hide();
            window.location.href = url;
        }
        function exportarPDFhorizontal() {
            var params = [];
            if (window.selectedPdfCols.length)
                params.push('cols=' + window.selectedPdfCols.join(','));
            if (window.selectedPdfIds.length)
                params.push('ids=' + window.selectedPdfIds.join(','));
            var url = "{% url 'bien_detalle:inventario_pdfh' nombre_bien categoria_id subcategoria_id %}";
            if (params.length) {
                url += '?' + params.join('&');
            }
            var modal = bootstrap.Modal.getInstance(document.getElementById('pdfExportModal'));
            modal.hide();
            window.location.href = url;
        }
    });
});
</script>
{% endblock %}
